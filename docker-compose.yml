version: '3.8'

# =================================================================
# 통합 배포용 Docker Compose
# 모든 서비스(admin, user, db, nginx)를 단일 파일로 관리합니다.
# Jenkins에서 이 파일을 사용하여 'docker compose up --build'를 실행합니다.
# =================================================================

networks:
  ict_network:
    driver: bridge
    name: ict_network

services:
  #---------------------------------
  # 데이터베이스
  #---------------------------------
  mariadb:
    image: mariadb:10.5
    container_name: ict05-mariadb
    environment:
      - MARIADB_ROOT_PASSWORD=rootpass123
      - MARIADB_DATABASE=ict05final
      - MARIADB_USER=ict05final
      - MARIADB_PASSWORD=ictpass123
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - ict_network
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

  #---------------------------------
  # ADMIN 서비스
  #---------------------------------
  admin-backend:
    build:
      context: . # admin-kw 프로젝트 루트
      dockerfile: Dockerfile
    container_name: ict05-admin-backend-kw
    image: loopwhile/ict05-final-admin-backend
    expose:
      - "8081" # 내부 통신용 포트
    environment:
      - SPRING_PROFILES_ACTIVE=prod,receive
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/ict05final
      - SPRING_DATASOURCE_USERNAME=ict05final
      - SPRING_DATASOURCE_PASSWORD=ictpass123
      - GOOGLE_APPLICATION_CREDENTIALS=/app/fcm-secret/firebase-admin.json
    volumes:
      - ./fcm-secret:/app/fcm-secret:ro
    networks:
      - ict_network
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped

  admin-pdf:
    build:
      context: ./python-pdf-download
      dockerfile: Dockerfile
    container_name: ict05-admin-pdf-kw
    image: loopwhile/ict05-final-admin-pdf
    expose:
      - "8000"
    networks:
      - ict_network
    restart: unless-stopped

  #---------------------------------
  # USER 서비스
  #---------------------------------
  user-backend:
    build:
      context: ${USER_PROJECT_PATH:-../ict05_final_user-kw} # user-kw 프로젝트 루트
      dockerfile: Dockerfile
    container_name: ict05-user-backend-kw
    image: loopwhile/ict05-final-user-backend
    expose:
      - "8082"
    environment:
      - SPRING_PROFILES_ACTIVE=prod,receive
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/ict05final
      - SPRING_DATASOURCE_USERNAME=ict05final
      - SPRING_DATASOURCE_PASSWORD=ictpass123
      - GOOGLE_APPLICATION_CREDENTIALS=/app/fcm-secret/firebase-admin.json
    volumes:
      - ${USER_PROJECT_PATH:-../ict05_final_user-kw}/fcm-secret:/app/fcm-secret:ro
    networks:
      - ict_network
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped

  user-frontend:
    build:
      context: ${USER_PROJECT_PATH:-../ict05_final_user-kw}/front-end
      dockerfile: Dockerfile
    container_name: ict05-user-frontend-kw
    image: loopwhile/ict05-final-user-frontend
    expose:
      - "80" # 프론트엔드 Nginx는 80번 포트로 서비스
    networks:
      - ict_network
    restart: unless-stopped

  user-pdf:
    build:
      context: ${USER_PROJECT_PATH:-../ict05_final_user-kw}/python-pdf-download
      dockerfile: Dockerfile
    container_name: ict05-user-pdf-kw
    image: loopwhile/ict05-final-user-pdf
    expose:
      - "8001"
    networks:
      - ict_network
    restart: unless-stopped

  #---------------------------------
  # NGINX 리버스 프록시
  #---------------------------------
  nginx:
    build:
      context: .
      dockerfile: nginx.Dockerfile # admin-kw 루트의 nginx.Dockerfile 사용
    container_name: ict05-nginx-kw
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - admin-backend
      - user-backend
      - user-frontend
    networks:
      - ict_network
    restart: always

volumes:
  db_data:
