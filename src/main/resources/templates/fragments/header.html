<!-- resources/templates/fragments/header.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Header</title>
    <script th:src="@{/js/csrf-attach.js}" defer></script>

</head>
<body>
    <th:block th:fragment="header">
        <aside id="aside" class="aside">
            <h1><img src="/admin/images/logo/toastlab.png" class="logo" alt="토스트랩"></h1>

            <nav id="nav" class="aside-nav">
                <ul>
                    <li>
                        <a href="/admin/home">
                            <span class="material-symbols-outlined">dashboard</span>
                            <span>대시보드</span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/store/list" class="toggle-sub">
                            <span class="material-symbols-outlined">storefront</span>
                            <span>가맹점</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/store/list"><span>가맹점 현황</span></a>
                            </li>
                            <li>
                                <a href="/admin/store/write"><span>가맹점 등록</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/menu/list" class="toggle-sub">
                            <span class="material-symbols-outlined">breakfast_dining</span>
                            <span>메뉴</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/menu/list"><span>메뉴 목록</span></a>
                            </li>
                            <li>
                                <a href="/admin/menu/write"><span>메뉴 등록</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/inventory/list" class="toggle-sub">
                            <span class="material-symbols-outlined">shelves</span>
                            <span>재고</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/inventory/list"><span>재고 현황</span></a>
                            </li>
                            <li>
                                <a href="/admin/inventory/in/write"><span>재료 입고</span></a>
                            </li>
                            <li>
                                <a href="/admin/material/list"><span>재료 목록</span></a>
                            </li>
                            <li>
                                <a href="/admin/receive/list"><span>수주 현황</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/staff/list" class="toggle-sub">
                            <span class="material-symbols-outlined">badge</span>
                            <span>인사</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/staff/list"><span>사원 목록</span></a>
                            </li>
                            <li>
                                <a href="/admin/staff/write"><span>사원 등록</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/notice/list" class="toggle-sub">
                            <span class="material-symbols-outlined">assignment</span>
                            <span>공지</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/notice/list"><span>공지 목록</span></a>
                            </li>
                            <li>
                                <a href="/admin/notice/write"><span>공지 등록</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/analytics/kpi" class="toggle-sub">
                            <span class="material-symbols-outlined">analytics</span>
                            <span>통계/리포트</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/analytics/kpi"><span>KPI 분석</span></a>
                            </li>
                            <li>
                                <a href="/admin/analytics/orders"><span>주문 분석</span></a>
                            </li>
                            <li>
                                <a href="/admin/analytics/materials"><span>자재 분석</span></a>
                            </li>
                            <li>
                                <a href="/admin/analytics/time"><span>시간 분석</span></a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/admin/member/list" class="toggle-sub">
                            <span class="material-symbols-outlined">schema</span>
                            <span>시스템 관리</span>
                        </a>
                        <ul>
                            <li>
                                <a href="/admin/member/list"><span>회원 관리</span></a>
                            </li>
                            <li>
                                <a href="/admin/navauth/list"><span>메뉴 관리</span></a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </aside>
        <header id="header" class="header">
            <div>
                <button type="button" class="btn toggle-nav">
                    <span class="material-symbols-outlined">
                        arrow_circle_left
                    </span>
                </button>
            </div><!-- #header > div : left-->

            <div>
                <div class="user">
                    <ul>
                        <li>
                            <button type="button" class="btn btn-toggle">
                                <!-- 업로드 이미지 있을 때: DB에는 파일명만 있으므로 /uploads/profile/{file} 붙여서 사용 -->
                                <img th:if="${loginMember != null and loginMember.memberImagePath != null}"
                                     th:src="@{/uploads/profile/{file}(file=${loginMember.memberImagePath})}"
                                     alt="프로필 이미지"
                                     class="img profile">
                                <!-- 업로드 이미지 없을 때: 기본 이미지 -->
                                <img th:unless="${loginMember != null and loginMember.memberImagePath != null}"
                                     th:src="@{/images/admin/default-profile.png}"
                                     alt="프로필 미리보기"
                                     class="img profile">
                            </button>
                            <div class="toggle-cont">
                                <ul>
                                    <li>
                                        <div class="item pack-left">
                                            <img th:if="${loginMember != null and loginMember.memberImagePath != null}"
                                                 th:src="@{/uploads/profile/{file}(file=${loginMember.memberImagePath})}"
                                                 alt="프로필 이미지"
                                                 class="img profile">
                                            <img th:unless="${loginMember != null and loginMember.memberImagePath != null}"
                                                 th:src="@{/images/admin/default-profile.png}"
                                                 alt="프로필 미리보기"
                                                 class="img profile">
                                            <div>
                                                <p th:text="${loginMember != null ? loginMember.name : 'Guest'}"></p>
                                                <p class="fs-s">admin</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <!-- 헤더 사용자 메뉴 어디든 한 줄 추가 -->
                                        <button type="button" class="btn btn-sm" id="btn-enable-push">알림 켜기</button>
                                        <button id="btn-sub-topic" class="btn btn-sm">전체 공지 구독</button>
                                        <button id="btn-unsub-topic" class="btn btn-sm">구독 해제</button>
                                    </li>
                                    <li>
                                        <a href="/admin/mypage" class="btn">
                                                <span class="material-symbols-outlined">
                                                    account_circle
                                                </span>
                                            <span>계정 관리</span>
                                        </a>
                                    </li>
                                    <li>
                                        <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        </form>

                                        <a href="#" class="btn" id="btn-logout">
                                            <span class="material-symbols-outlined">logout</span>
                                            <span>로그아웃</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
            </div><!-- #header > div : right-->
        </header>
        <!--전체 구독-->
        <script>
            document.getElementById('btn-sub-topic')?.addEventListener('click', () => {
              fetch('/admin/fcm/topic/subscribe?topic=hq-all', { method:'POST' })
                .then(()=>alert('구독 완료'));
            });
            document.getElementById('btn-unsub-topic')?.addEventListener('click', () => {
              fetch('/admin/fcm/topic/unsubscribe?topic=hq-all', { method:'POST' })
                .then(()=>alert('구독 해제'));
            });
        </script>
        <script>
            // 알림켜기 버튼
            document.getElementById('btn-enable-push')?.addEventListener('click', () => {
              window.enableWebPush && window.enableWebPush();
            });
        </script>
        <script>
            // 로그아웃 시: FCM 토큰 비활성화 → 실제 로그아웃 순서로 처리
            document.addEventListener('DOMContentLoaded', () => {
              const btn  = document.getElementById('btn-logout');
              const form = document.getElementById('logoutForm');
              if (!btn || !form) return;

              btn.addEventListener('click', async (e) => {
                e.preventDefault();

                try {
                  const token = localStorage.getItem('fcm_token');
                  if (token) {
                    await fetch(`/admin/fcm/register/${encodeURIComponent(token)}`, {
                      method: 'DELETE'
                      // CSRF 헤더는 csrf-attach.js가 same-origin 변경요청에 자동 부착됨
                    });
                  }
                } catch (err) {
                  console.warn('[FCM] unregister failed (continue logout):', err);
                } finally {
                  localStorage.removeItem('fcm_token'); // 클라이언트 정리
                  form.submit();                        // 실제 로그아웃 진행 (/admin/logout POST)
                }
              });
            });
        </script>
    </th:block>
</body>
</html>
