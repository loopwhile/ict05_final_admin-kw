<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
    <th:block th:replace="~{fragments/head :: commonHead}"></th:block>

    <link href="/admin/css/toast.css" rel="stylesheet"/>
    <script src="/admin/js/lib/jquery-3.2.1.min.js"></script>
    <script src="/admin/js/toast.js"></script>
</head>
<body>
<div id="wrap" class="frame">
    <div th:replace="~{fragments/header :: header}"></div>

    <div id="container" class="container">
        <div class="title-bar">
            <h2 class="page-title ellipsis">메뉴 수정</h2>
        </div>

        <main id="content" >
            <div class="write-form box-wrap">
                <!-- 폼 시작 -->
                <form id="frm" th:object="${menuModifyFormDTO}"
                      th:action="@{/API/menu/modify/{id}(id=*{menuId})}" method="post">

                <input type="hidden" th:field="*{menuId}"/>

                    <!-- 기본 정보 -->
                    <fieldset class="pack-down gap-12">
                        <legend class="blind">기본 정보</legend>

                        <div class="">
                            <div class="field pack-down">
                                <label class="label medium required" for="menuName">메뉴명 *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuName" class="input-text large"
                                           th:field="*{menuName}" placeholder="메뉴명 입력"/>
                                    <p id="menuNameError" class="warning"></p>
                                </div>
                            </div>
                        </div>

                        <div class="row-2">
                            <div class="field pack-down col">
                                <label class="label medium" for="menuNameEnglish">영문명</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuNameEnglish" class="input-text medium"
                                           th:field="*{menuNameEnglish}" placeholder="영문명 입력"/>
                                    <p id="menuNameEnglishError" class="warning"></p>
                                </div>
                            </div>

                            <div class="field pack-down col">
                                <label class="label medium" for="menuCode">상품코드</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuCode" class="input-text medium"
                                           th:field="*{menuCode}" placeholder="상품코드 입력"/>
                                    <p id="menuCodeError" class="warning"></p>
                                </div>
                            </div>
                        </div>

                        <div class="row-2">
                            <div class="field pack-down col">
                                <label class="label medium required" for="menuCategoryId">카테고리</label>
                                <div class="insert pack-down">
                                    <select id="menuCategoryId" class="select medium"
                                            th:field="*{menuCategoryId}">
                                        <!-- 등록 화면과 동일한 placeholder -->
                                        <option value="" disabled
                                                th:selected="*{menuCategoryId} == null">
                                            카테고리 선택
                                        </option>

                                        <!-- 실제 카테고리 목록 -->
                                        <option th:each="c : ${menuCategories}"
                                                th:value="${c.menuCategoryId}"
                                                th:text="${c.menuCategoryName}">
                                        </option>
                                    </select>
                                    <p id="menuCategoryIdError" class="warning"></p>
                                </div>
                            </div>

                            <!-- 수정화면: 판매상태 (등록화면과 동일한 UI) -->
                            <div class="field pack-down col">
                                <span class="fs-ss fc-999">판매 상태 *</span>
                                <div class="pack-down">
                                    <div class="select-options r4">
                                        <label th:each="s : ${menuShowValues}">
                                            <!-- th:field 로 Enum 바인딩 + s 값을 value 로 -->
                                            <input type="radio"
                                                   th:field="*{menuShow}"
                                                   th:value="${s}"
                                                   required>
                                            <span class="btn medium r4" th:text="${s.description}">판매상태</span>
                                        </label>
                                    </div>
                                </div>
                                <p id="menuShowError" class="warning"></p>
                            </div>

                        </div>

                        <div class="row-2">
                            <div class="field pack-down col">
                                <label class="label medium" for="menuPrice">가격(원)</label>
                                <div class="insert pack-down">
                                    <input type="number" id="menuPrice" class="input-text medium"
                                           min="0" step="1" inputmode="numeric"
                                           th:value="${menuModifyFormDTO.menuPrice != null ? #numbers.formatInteger(menuModifyFormDTO.menuPrice.longValue(), 0, 'NONE') : 0}"
                                           name="menuPrice" placeholder="예: 6500"/>
                                    <p id="menuPriceError" class="warning"></p>
                                </div>
                            </div>

                            <div class="field pack-down col">
                                <label class="label medium" for="menuKcal">칼로리(kcal)</label>
                                <div class="insert pack-down">
                                    <input type="number" id="menuKcal" class="input-text medium" min="0" step="1"
                                           th:field="*{menuKcal}" placeholder="예: 510"/>
                                    <p id="menuKcalError" class="warning"></p>
                                </div>
                            </div>
                        </div>

                        <div class="field pack-down">
                            <label class="label medium" for="menuInformation">설명</label>
                            <div class="insert pack-down">
                                <textarea id="menuInformation" class="input-text" rows="4"
                                          th:field="*{menuInformation}" placeholder="설명 입력"></textarea>
                                <p id="menuInformationError" class="warning"></p>
                            </div>
                        </div>
                    </fieldset>

                    <!-- 재료구성 (수정화면) -->
                    <div class="card p-3">
                        <h5 class="mb-3">재료구성</h5>

                        <div class="row">
                            <!-- 주재료 -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>주재료 구성</strong>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMainRow()">+ 재료 추가</button>
                                </div>

                                <div id="mainRows" class="border border-2 rounded p-3" style="min-height:84px;">
                                    <div class="text-muted small" data-placeholder="main"
                                         th:if="${#lists.isEmpty(menuModifyFormDTO.mainMaterials)}">주재료를 추가해주세요</div>

                                    <!-- 서버에서 미리 그려주는 기존 행 -->
                                    <div class="row g-2 align-items-center mb-2" data-role="row"
                                         th:each="it, iStat : *{mainMaterials}">
                                        <input type="hidden"
                                               th:name="'mainMaterials[' + ${iStat.index} + '].menuRecipeId'"
                                               th:value="${it.menuRecipeId}"/>
                                        <input type="hidden"
                                               th:name="'mainMaterials[' + ${iStat.index} + '].deleteFlag'"
                                               value="false"/>

                                        <div class="col-4">
                                            <select class="form-select"
                                                    th:name="'mainMaterials[' + ${iStat.index} + '].materialId'">
                                                <option value="" disabled>재료 선택</option>
                                                <option th:each="m : ${mainOptions}"
                                                        th:value="${m.materialId}"
                                                        th:text="${m.materialName}"
                                                        th:selected="${it.materialId} == ${m.materialId}"></option>
                                            </select>
                                        </div>

                                        <div class="col-3">
                                            <input type="number" min="0" step="0.01" class="form-control"
                                                   th:name="'mainMaterials[' + ${iStat.index} + '].recipeQty'"
                                                   th:value="${it.recipeQty}"/>
                                        </div>

                                        <div class="col-3">
                                            <select class="form-select"
                                                    th:name="'mainMaterials[' + ${iStat.index} + '].recipeUnit'">
                                                <option value="" disabled>단위</option>
                                                <option th:each="u : ${units}" th:value="${u}" th:text="${u}"
                                                        th:selected="${it.recipeUnit} == ${u}"></option>
                                            </select>
                                        </div>

                                        <div class="col-2 text-end">
                                            <button type="button" class="btn btn-light border" onclick="markOrRemove(this)">×</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 소스 -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>소스 구성</strong>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSauceRow()">+ 소스 추가</button>
                                </div>

                                <div id="sauceRows" class="border border-2 rounded p-3" style="min-height:84px;">
                                    <div class="text-muted small" data-placeholder="sauce"
                                         th:if="${#lists.isEmpty(menuModifyFormDTO.sauceMaterials)}">소스를 추가해주세요</div>

                                    <!-- 서버에서 미리 그려주는 기존 행 -->
                                    <div class="row g-2 align-items-center mb-2" data-role="row"
                                         th:each="it, iStat : *{sauceMaterials}">
                                        <input type="hidden"
                                               th:name="'sauceMaterials[' + ${iStat.index} + '].menuRecipeId'"
                                               th:value="${it.menuRecipeId}"/>
                                        <input type="hidden"
                                               th:name="'sauceMaterials[' + ${iStat.index} + '].deleteFlag'"
                                               value="false"/>

                                        <div class="col-4">
                                            <select class="form-select"
                                                    th:name="'sauceMaterials[' + ${iStat.index} + '].materialId'">
                                                <option value="" disabled>재료 선택</option>
                                                <option th:each="m : ${sauceOptions}"
                                                        th:value="${m.materialId}"
                                                        th:text="${m.materialName}"
                                                        th:selected="${it.materialId} == ${m.materialId}"></option>

                                            </select>
                                        </div>

                                        <div class="col-3">
                                            <input type="number" min="0" step="0.01" class="form-control"
                                                   th:name="'sauceMaterials[' + ${iStat.index} + '].recipeQty'"
                                                   th:value="${it.recipeQty}"/>
                                        </div>

                                        <div class="col-3">
                                            <select class="form-select"
                                                    th:name="'sauceMaterials[' + ${iStat.index} + '].recipeUnit'">
                                                <option value="" disabled>단위</option>
                                                <option th:each="u : ${units}" th:value="${u}" th:text="${u}"
                                                        th:selected="${it.recipeUnit} == ${u}"></option>
                                            </select>
                                        </div>

                                        <div class="col-2 text-end">
                                            <button type="button" class="btn btn-light border" onclick="markOrRemove(this)">×</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 동적 행 템플릿 (수정화면용) -->
                    <template id="tpl-main-row">
                        <div class="row g-2 align-items-center mb-2" data-role="row">
                            <input type="hidden" name="mainMaterials[__INDEX__].menuRecipeId"/>
                            <input type="hidden" name="mainMaterials[__INDEX__].deleteFlag" value="false"/>

                            <div class="col-4">
                                <select class="form-select" name="mainMaterials[__INDEX__].materialId">
                                    <option value="" selected disabled>재료 선택</option>
                                    <th:block th:each="m : ${mainOptions}">
                                        <option th:value="${m.materialId}" th:text="${m.materialName}"></option>
                                    </th:block>
                                </select>
                            </div>

                            <div class="col-3">
                                <input type="number" min="0" step="1" class="form-control"
                                       name="mainMaterials[__INDEX__].recipeQty" placeholder="수량">
                            </div>

                            <div class="col-3">
                                <select class="form-select" name="mainMaterials[__INDEX__].recipeUnit">
                                    <option value="" selected disabled>단위</option>
                                    <option th:each="u : ${units}" th:value="${u}" th:text="${u}"></option>
                                </select>
                            </div>

                            <div class="col-2 text-end">
                                <button type="button" class="btn btn-light border" onclick="markOrRemove(this)">×</button>
                            </div>
                        </div>
                    </template>

                    <template id="tpl-sauce-row">
                        <div class="row g-2 align-items-center mb-2" data-role="row">
                            <input type="hidden" name="sauceMaterials[__INDEX__].menuRecipeId"/>
                            <input type="hidden" name="sauceMaterials[__INDEX__].deleteFlag" value="false"/>

                            <div class="col-4">
                                <select class="form-select" name="sauceMaterials[__INDEX__].materialId">
                                    <option value="" selected disabled>재료 선택</option>
                                    <th:block th:each="m : ${sauceOptions}">
                                        <option th:value="${m.materialId}" th:text="${m.materialName}"></option>
                                    </th:block>
                                </select>
                            </div>

                            <div class="col-3">
                                <input type="number" min="0" step="1" class="form-control"
                                       name="sauceMaterials[__INDEX__].recipeQty" placeholder="수량">
                            </div>

                            <div class="col-3">
                                <select class="form-select" name="sauceMaterials[__INDEX__].recipeUnit">
                                    <option value="" selected disabled>단위</option>
                                    <option th:each="u : ${units}" th:value="${u}" th:text="${u}"></option>
                                </select>
                            </div>

                            <div class="col-2 text-end">
                                <button type="button" class="btn btn-light border" onclick="markOrRemove(this)">×</button>
                            </div>
                        </div>
                    </template>

                    <div class="button-area pack-both" style="display:flex; justify-content:space-between; gap:20px; margin-top:20px;">
                        <a th:href="@{/menu/detail/{id}(id=*{menuId})}" class="btn medium color1">상세로</a>
                        <div class="pack-right" style="display:flex; gap:8px;">
                            <a href="/admin/menu/list" class="btn medium">목록</a>
                            <button type="submit" class="btn large color2">저장</button>
                        </div>
                    </div>
                </form>
                <!-- 폼 끝 -->
            </div>
        </main>

        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>
</div>

<script>
    // 행 추가
    function addMainRow()  { addRow('mainRows',  'tpl-main-row',  'mainMaterials'); }
    function addSauceRow() { addRow('sauceRows', 'tpl-sauce-row', 'sauceMaterials'); }

    function addRow(containerId, tplId, base) {
      const box = document.getElementById(containerId);
      const idx = box.querySelectorAll('[data-role="row"]').length;
      const html = document.getElementById(tplId).innerHTML.replaceAll('__INDEX__', idx);
      box.insertAdjacentHTML('beforeend', html);
      togglePlaceholder(box);
    }

    // 기존 레코드는 deleteFlag=true로 표시하고 숨김; 신규는 그냥 제거
    function markOrRemove(btn) {
      const row = btn.closest('[data-role="row"]');
      const idInput = row.querySelector('input[name$=".menuRecipeId"]');
      const delInput = row.querySelector('input[name$=".deleteFlag"]');
      if (idInput && idInput.value) {           // DB에 있던 행
        delInput.value = 'true';
        row.style.display = 'none';
      } else {                                  // 새로 추가한 행
        row.remove();
        reindex(row.closest('.border'), findBase(row));
      }
      togglePlaceholder(row.closest('.border'));
    }

    function findBase(row) {
      return row.querySelector('input[name*="mainMaterials"]') ? 'mainMaterials' : 'sauceMaterials';
    }

    // 인덱스 재정렬
    function reindex(container, base) {
      const rows = Array.from(container.querySelectorAll('[data-role="row"]'))
                        .filter(r => r.style.display !== 'none');
      rows.forEach((r, i) => {
        r.querySelectorAll('[name]').forEach(el => {
          el.name = el.name.replace(new RegExp(base + '\\[\\d+\\]'), base + '[' + i + ']');
        });
      });
    }

    function togglePlaceholder(box) {
      const hasRow = box.querySelectorAll('[data-role="row"]:not([style*="display: none"])').length > 0;
      const ph = box.querySelector('[data-placeholder]');
      if (ph) ph.style.display = hasRow ? 'none' : '';
    }
</script>

<script>
    document.getElementById('frm').addEventListener('submit', function(e) {
      e.preventDefault();

      // FormData → 일반 URL 인코딩으로 변환
      const formData = new FormData(this);
      const params = new URLSearchParams();
      formData.forEach((v, k) => params.append(k, v));

      fetch(this.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success) throw new Error();
        location.href = `/admin/menu/detail/${data.id}`;
      })
      .catch(() => alert('저장 실패'));
    });
</script>


</body>
</html>
