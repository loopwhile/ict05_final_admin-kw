<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
    <th:block th:replace="~{fragments/head :: commonHead}"></th:block>

    <link href="/admin/css/toast.css" rel="stylesheet"/>
    <script src="/admin/js/lib/jquery-3.2.1.min.js"></script>
    <script src="/admin/js/toast.js"></script>

</head>
<body>
<div id="wrap" class="frame">
    <div th:replace="~{fragments/header :: header}"></div>
    <div id="container" class="container">
        <div class="title-bar">
            <h2 class="page-title ellipsis">메뉴 등록</h2>
        </div>

        <main id="content">
            <div class="write-form box-wrap">

                <form id="frm"
                      th:object="${menuWriteFormDTO}"
                      method="post"
                      th:action="@{/menu/write}"
                      enctype="multipart/form-data">

                    <fieldset class="pack-down gap-12">
                        <legend class="blind">기본 정보</legend>

                        <!-- 카테고리 -->
                        <div class="field pack-down col">
                            <label class="label medium required" for="menuCategoryId">카테고리 *</label>
                            <div class="insert pack-down">
                                <select id="menuCategoryId" class="select medium" th:field="*{menuCategoryId}">
                                    <option value="" disabled selected>카테고리 선택</option>
                                    <option th:each="c : ${menuCategories}"
                                            th:value="${c.menuCategoryId}"
                                            th:text="${c.menuCategoryName}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- 메뉴명 / 영문명 -->
                        <div class="row-2">
                            <div class="field pack-down col">
                                <label class="label medium" for="menuName">메뉴명 *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuName" class="input-text large"
                                           th:field="*{menuName}" placeholder="예: 베이컨 에그 토스트"/>
                                </div>
                            </div>

                            <div class="field pack-down col">
                                <label class="label medium" for="menuNameEnglish">영문명 *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuNameEnglish" class="input-text large"
                                           th:field="*{menuNameEnglish}" placeholder="예: Bacon Egg Toast"/>
                                </div>
                            </div>
                        </div>

                        <!-- 가격 / 칼로리 -->
                        <div class="row-2">
                            <div class="field pack-down col">
                                <label class="label medium" for="menuPrice">가격(원) *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuPrice" class="input-text large"
                                           th:field="*{menuPrice}" placeholder="4500"/>
                                </div>
                            </div>

                            <div class="field pack-down col">
                                <label class="label medium" for="menuKcal">칼로리(kcal) *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuKcal" class="input-text large"
                                           th:field="*{menuKcal}" placeholder="예: 320"/>
                                </div>
                            </div>
                        </div>

                        <!-- 설명 -->
                        <div class="field pack-down col">
                            <label class="label medium" for="menuInformation">설명 *</label>
                            <div class="insert pack-down">
                                <input type="text" id="menuInformation" class="input-text large"
                                       th:field="*{menuInformation}" placeholder="상품 설명"/>
                            </div>
                        </div>

                        <!-- 판매 상태 / 코드 -->
                        <div class="row-2">
                            <div class="field pack-down col">
                                <span class="fs-ss fc-999">판매 상태 *</span>
                                <div class="pack-down">
                                    <div class="select-options r4">
                                        <label th:each="s : ${menuShowValues}">
                                            <input type="radio" th:field="*{menuShow}" th:value="${s}" required>
                                            <span class="btn medium r4" th:text="${s.description}"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="field pack-down col">
                                <label class="label medium" for="menuCode">상품코드 *</label>
                                <div class="insert pack-down">
                                    <input type="text" id="menuCode" class="input-text large"
                                           th:field="*{menuCode}" placeholder="상품 코드"/>
                                </div>
                            </div>
                        </div>

                        <!-- 재료구성 -->
                        <div class="card p-3">
                            <h5 class="mb-3">재료구성</h5>

                            <div class="row">
                                <!-- 주재료 -->
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>주재료 구성</strong>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMainRow()">+ 재료 추가</button>
                                    </div>
                                    <div id="mainRows" class="border border-2 rounded p-3" style="min-height:84px;">
                                        <div class="text-muted small" data-placeholder="main">주재료를 추가해주세요</div>
                                    </div>
                                </div>

                                <!-- 소스 -->
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>소스 구성</strong>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSauceRow()">+ 소스 추가</button>
                                    </div>
                                    <div id="sauceRows" class="border border-2 rounded p-3" style="min-height:84px;">
                                        <div class="text-muted small" data-placeholder="sauce">소스를 추가해주세요</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 템플릿 -->
                        <!-- 주재료 -->
                        <template id="tpl-main-row">
                            <div class="row g-2 align-items-center mb-2" data-role="row">
                                <div class="col-3">
                                    <select class="form-select" name="mainMaterials[__INDEX__].materialId" >
                                        <option value="" selected disabled>재료 선택</option>
                                        <th:block th:each="m : ${mainOptions}">
                                            <option th:value="${m.materialId}" th:text="${m.materialName}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-2">
                                    <input type="number" step="0.01" min="0" class="form-control"
                                           name="mainMaterials[__INDEX__].recipeQty" placeholder="수량" >
                                </div>
                                <div class="col-3">
                                    <select class="form-select" name="mainMaterials[__INDEX__].recipeUnit" >
                                        <option value="" selected disabled>단위</option>
                                        <option th:each="u : ${units}" th:value="${u}" th:text="${u}"></option>
                                    </select>
                                </div>
                                <div class="col-1 text-end">
                                    <button type="button" class="btn btn-light border" onclick="removeRow(this)">×</button>
                                </div>
                            </div>
                        </template>

                        <!-- 소스 -->
                        <template id="tpl-sauce-row">
                            <div class="row g-2 align-items-center mb-2" data-role="row">
                                <div class="col-3">
                                    <select class="form-select" name="sauceMaterials[__INDEX__].materialId" >
                                        <option value="" selected disabled>소스 선택</option>
                                        <th:block th:each="s : ${sauceOptions}">
                                            <option th:value="${s.materialId}" th:text="${s.materialName}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-2">
                                    <input type="number" step="0.01" min="0" class="form-control"
                                           name="sauceMaterials[__INDEX__].recipeQty" placeholder="수량" >
                                </div>
                                <div class="col-3">
                                    <select class="form-select" name="sauceMaterials[__INDEX__].recipeUnit" >
                                        <option value="" selected disabled>단위</option>
                                        <option th:each="u : ${units}" th:value="${u}" th:text="${u}"></option>
                                    </select>
                                </div>
                                <div class="col-1 text-end">
                                    <button type="button" class="btn btn-light border" onclick="removeRow(this)">×</button>
                                </div>
                            </div>
                        </template>
                    </fieldset>
                </form>
            </div>

            <div class="button-area pack-both" style="display:flex; justify-content:space-between; gap:20px; margin-top:20px;">
                <a href="/admin/menu/list" class="btn medium color1">목록</a>
                <a id="btnSave" href="#" class="btn large color1">저장</a>
            </div>
        </main>

        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>
</div>

<script>
    let mainIdx = 0, sauceIdx = 0;
    function addMainRow() { addRow('tpl-main-row','mainRows','main',mainIdx++); }
    function addSauceRow() { addRow('tpl-sauce-row','sauceRows','sauce',sauceIdx++); }

    function addRow(tplId, containerId, kind, idx) {
        const container = document.getElementById(containerId);
        const tpl = document.getElementById(tplId);
        const ph = container.querySelector('[data-placeholder]');
        if (ph) ph.remove();
        const frag = tpl.content.cloneNode(true);
        frag.querySelectorAll('[name]').forEach(el => el.name = el.name.replace('__INDEX__', idx));
        container.appendChild(frag);
    }

    function removeRow(btn) {
        const row = btn.closest('[data-role="row"]');
        const container = row.parentElement;
        row.remove();
        if (container && container.children.length === 0) {
            const kind = (container.id === 'mainRows') ? 'main' : 'sauce';
            const div = document.createElement('div');
            div.className = 'text-muted small';
            div.dataset.placeholder = kind;
            div.textContent = (kind === 'main') ? '주재료를 추가해주세요' : '소스를 추가해주세요';
            container.appendChild(div);
            if (kind === 'main') mainIdx = 0; else sauceIdx = 0;
        }
    }

    document.getElementById('btnSave')?.addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('frm')?.requestSubmit();
    });
</script>
</body>
</html>
