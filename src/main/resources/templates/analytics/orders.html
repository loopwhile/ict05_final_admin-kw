<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="robots" content="noindex">
  <meta name="googlebot" content="noindex">
  <!-- Bootstrap CSS CDN -->
  <th:block th:replace="~{fragments/head :: commonHead}"></th:block>

  <link href="/admin/css/toast.css" rel="stylesheet"/>
  <script src="/admin/js/lib/jquery-3.2.1.min.js"></script>
  <script src="/admin/js/toast.js"></script>
  <style>
    .wrap{padding:20px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:18px}
    .num{font-size:28px;font-weight:700}
    .hint{color:#777;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .up{background:#e6f4ea;color:#137333}
    .down{background:#fce8e6;color:#a50e0e}
    .title{font-size:14px;color:#666;margin-bottom:6px}
    .panel{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f3f5}
    .iconBubble{width:48px;height:48px;border-radius:999px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center}
    .grad1{background:linear-gradient(135deg,#5b8cff,#5b8cffcc);color:#fff}
    .grad2{background:linear-gradient(135deg,#34c759,#34c759cc);color:#fff}
    .grad3{background:linear-gradient(135deg,#ff8a34,#ff8a34cc);color:#fff}
    .grad4{background:linear-gradient(135deg,#8a5bff,#8a5bffcc);color:#fff}

    /* 드롭다운 위치, 레이아웃 수정 */
    #storeFilter {position: relative;}
    #storeFilter .filter-menu {position: absolute;top: 38px;left: 0;width: 280px;background: #fff;
      border: 1px solid #ddd;border-radius: 8px;box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      display: none;z-index: 1000;}
    #storeFilter.open .filter-menu {display: block;}
    #storeFilter .filter-body {max-height: 260px;overflow-y: auto;padding: 8px 10px;}
    #storeFilter .filter-list label {display: flex;align-items: center;gap: 6px;padding: 4px 0;cursor: pointer;}
    #storeFilter .filter-all {display: flex;align-items: center;gap: 6px;border-bottom: 1px solid #f1f3f5;
      margin-bottom: 6px;padding-bottom: 8px;}
    #storeFilterBtn {display: flex;align-items: center;justify-content: space-between;gap: 6px;min-width: 100px;}
    #storeFilter .caret {font-size: 11px;color: #555;}
    #storeFilter .filter-list label{display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:6px;cursor:pointer;transition:background .15s ease;position:relative;}
    #storeFilter .filter-list label:hover{background:#f8f9fa;}
    #storeFilter .filter-list input[type="checkbox"]:checked + span{font-weight:600;color:#0d6efd;}
    #storeFilter .filter-list input[type="checkbox"]:checked + span::before{content:"✔";color:#0d6efd;font-size:12px;margin-right:6px;}
    #storeFilter .filter-all input[type="checkbox"]:checked + span{font-weight:600;color:#0d6efd;}
  </style>
</head>
<body>
<div id="wrap" class="frame">
  <div th:replace="~{fragments/header :: header}"></div>

  <div id="container" class="container">
    <div class="title-bar">
      <h2 class="page-title ellipsis">주문 분석</h2>
    </div>

    <main id="content">
      <div class="pack-down gap-20">
        <!-- 요약 카드 -->
        <div class="row-4">
          <div class="col box-wrap">
            <div class="title">Transaction</div>
            <div class="num" th:text="|${#numbers.formatDecimal(orderCard.transaction?:0, 0, 'COMMA', 0, 'POINT')} 건|">0 건</div>
            <span class="hint">올해 누적</span>
          </div>
          <div class="col box-wrap">
            <div class="title">Delivery Sales</div>
            <div class="num" th:text="|${#numbers.formatDecimal(orderCard.deliverySales?:0, 0, 'COMMA', 0, 'POINT')} 원|">0 원</div>
            <span class="hint">올해 누적</span>
          </div>
          <div class="col box-wrap">
            <div class="title">Takeout Sales</div>
            <div class="num" th:text="|${#numbers.formatDecimal(orderCard.takeoutSales?:0, 0, 'COMMA', 0, 'POINT')} 원|">0 원</div>
            <span class="hint">올해 누적</span>
          </div>
          <div class="col box-wrap">
            <div class="title">Visit Sales</div>
            <div class="num" th:text="|${#numbers.formatDecimal(orderCard.visitSales?:0, 0, 'COMMA', 0, 'POINT')} 원|">0 원</div>
            <span class="hint">올해 누적</span>
          </div>
        </div>

        <div class="row-4">
          <div class="col box-wrap">
            <div class="title">Category Count</div>
            <div class="pack-down" style="margin-top:8px;">
              <div th:each="c, iStat : ${orderCard.categoriesByCount}">
                <span th:text="|${iStat.index + 1}. ${c.categoryName}|">1. 카테고리명</span>
                <span class="fs-ss" th:text="|(${#numbers.formatDecimal(c.units?:0, 0, 'COMMA', 0, 'POINT')} 개)|">0 개</span>
              </div>
              <div class="hint">올해 누적(카테고리별 판매수량)</div>
            </div>
          </div>

          <div class="col box-wrap">
            <div class="title">Category Sales</div>
            <div class="pack-down" style="margin-top:8px;">
              <div th:each="c, iStat : ${orderCard.categoriesBySales}">
                <span th:text="|${iStat.index + 1}. ${c.categoryName}|">1. 카테고리명</span>
                <span class="fs-ss" th:text="|(${#numbers.formatDecimal(c.sales?:0, 0, 'COMMA', 0, 'POINT')} 원)|">0 원</span>
              </div>
              <div class="hint">올해 누적(카테고리별 매출)</div>
            </div>
          </div>

          <div class="col box-wrap">
            <div class="title">Menu Count</div>
            <div class="num" th:text="|${#numbers.formatDecimal(orderCard.menuCount?:0, 0, 'COMMA', 0, 'POINT')} 개|">0 개</div>
            <span class="hint">올해 누적(판매수량 합계)</span>
          </div>

          <div class="col box-wrap">
            <div class="title">Menu Top3</div>
            <div class="hint" style="margin-top:8px;">
              <div th:each="tm, iStat : ${orderCard.topMenus}">
                <span th:text="|${iStat.index + 1}. ${tm.menuName}|">1. 메뉴명</span>
                <span class="fs-ss" th:text="|(${#numbers.formatDecimal(tm.sales?:0, 0, 'COMMA', 0, 'POINT')}원)|">0원</span>
              </div>
            </div>
            <span class="hint">올해 누적(이름 + 매출)</span>
          </div>
        </div>
      </div>

      <div class="box-wrap">
        <!-- 필터 조회 영역 -->
        <div id="search" class="search">
          <!-- ✅ SSR GET 제출 (Ajax 미사용) -->
          <form id="frm" method="get" th:action="@{/analytics/orders}">
            <fieldset class="pack-down gap-8">
              <legend class="blind">검색</legend>

              <!-- 검색 제출 시 1페이지로 -->
              <input type="hidden" name="page" value="1"/>


              <div class="pack-both-down">
                <!-- 가맹점 선택 -->
                <div class="pack-left">
                  <span class="fs-ss">가맹점 선택</span>
                  <div class="pack-left" id="storeFilter" style="position:relative;">
                    <button type="button" class="btn medium bdr-color1" id="storeFilterBtn">
                      <span id="storeFilterLabel">전체</span><span class="caret">▼</span>
                    </button>
                    <div class="box-wrap filter-menu" id="storeFilterMenu">
                      <div class="pack-both" style="padding:8px 10px;border-bottom:1px solid #f1f3f5;">
                        <input type="search" class="input-text small" id="storeSearch" placeholder="매장 검색"/>
                      </div>
                      <div class="filter-body">
                        <label class="filter-all">
                          <input type="checkbox" id="storeAll"
                                 th:checked="${#lists.isEmpty(analyticsSearchDto.storeIds)}">
                          <span>전체</span>
                        </label>
                        <div class="filter-list">
                          <label th:each="st : ${stores}">
                            <input type="checkbox" name="storeIds" th:value="${st.id}"
                                   th:checked="${analyticsSearchDto.storeIds != null} ? ${#lists.contains(analyticsSearchDto.storeIds, st.id)} : false">
                            <span th:text="${st.name}">Store A</span>
                          </label>
                        </div>
                      </div>
                      <div class="pack-both" style="padding:8px 10px;border-top:1px solid #f1f3f5;">
                        <button type="button" class="btn small color1" onclick="applyStoreFilter()">적용</button>
                        <button type="button" class="btn small bdr-color1" onclick="resetStoreFilter()">초기화</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- 기간 -->
                <div class="pack-right">
                  <label class="pack-left">
                    <span class="fs-ss">조회시작일</span>
                    <input type="date" class="input-text medium form-control" name="startDate"
                           th:value="${#temporals.format(analyticsSearchDto.startDate, 'yyyy-MM-dd')}"/>
                  </label>
                  <label class="pack-left">
                    <span class="fs-ss">조회종료일</span>
                    <input type="date" class="input-text medium form-control" name="endDate"
                           th:value="${#temporals.format(analyticsSearchDto.endDate, 'yyyy-MM-dd')}"/>
                  </label>
                </div>

                <div class="pack-right">
                  <div class="pack-right">
                    <!-- 일/월 + 페이지 사이즈 -->
                    <div class="pack-left">
                      <div class="btn medium bdr-color1 btn-group btn-group-toggle" data-bs-toggle="buttons">
                        <label class="btn medium" th:classappend="${analyticsSearchDto.viewBy?.name() == 'DAY'} ? ' active' : ''">
                          <input type="radio" name="viewBy" value="DAY" th:checked="${analyticsSearchDto.viewBy?.name() == 'DAY'}">일별
                        </label>
                        <label class="btn medium" th:classappend="${analyticsSearchDto.viewBy?.name() == 'MONTH'} ? ' active' : ''">
                          <input type="radio" name="viewBy" value="MONTH" th:checked="${analyticsSearchDto.viewBy?.name() == 'MONTH'}">월별
                        </label>
                      </div>

                      <!-- ✅ Total 토글 -->
                      <span class="fs-ss">요약(합계)</span>
                      <div class="btn medium bdr-color1 btn-group btn-group-toggle" data-bs-toggle="buttons" role="group" style="margin-left:8px;">
                        <label class="btn medium" th:classappend="${analyticsSearchDto.showTotal} ? ' active' : ''">
                          <input type="radio" name="showTotal" value="true" th:checked="${analyticsSearchDto.showTotal}"> 보이기
                        </label>
                        <label class="btn medium" th:classappend="${!analyticsSearchDto.showTotal} ? ' active' : ''">
                          <input type="radio" name="showTotal" value="false" th:checked="${!analyticsSearchDto.showTotal}"> 숨기기
                        </label>
                      </div>

                      <div class="pack-left page-size">
                        <!-- ✅ Pageable 표준 파라미터명: size -->
                        <select title="출력개수" name="size" class="select medium" id="pageSizeSelect">
                          <option th:value="50"  th:selected="${orderrows.size == 50}">50</option>
                          <option th:value="100" th:selected="${orderrows.size == 100}">100</option>
                          <option th:value="150" th:selected="${orderrows.size == 150}">150</option>
                          <option th:value="200" th:selected="${orderrows.size == 200}">200</option>
                          <option th:value="250" th:selected="${orderrows.size == 250}">250</option>
                          <option th:value="300" th:selected="${orderrows.size == 300}">300</option>
                        </select>
                        <span class="fs-ss">개씩 보기</span>
                      </div>
                    </div>
                    <!-- 조회 버튼: 폼 submit -->
                    <input type="submit" class="btn medium color1" value="조회"/>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>
        </div>

        <!-- 목록 테이블 -->
        <section class="pack-down">
          <div class="list-header pack-both">
            <div class="pack-left">
              <button type="button" class="btn medium bdr-color1" onclick="excelDownload()">엑셀다운로드</button>
              <button type="button" class="btn medium bdr-color1" onclick="pdfDownload()">PDF다운로드</button>
            </div>
          </div>
          <!-- ✅ 기존 <table class="data-table"> ... </table> 통째로 교체 -->
          <table class="data-table">
            <thead>
            <tr>
              <th>Date</th>
              <th th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}">OrderDate</th>
              <th>Store</th>
              <th th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}">OrderId</th>
              <th th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}">Category</th>
              <th th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}">Menu</th>
              <th>MenuCount</th>
              <th>MenuSales</th>
              <th>OrderCount</th>
              <th>OrderSales</th>
              <!-- ✅ OrderType은 일별만 -->
              <th th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}">OrderType</th>
            </tr>
            </thead>
            <tbody>

            <!-- 본문 -->
            <tr th:if="${#lists.isEmpty(orderrows.content)}">
              <td colspan="11" class="ta-c">조회 결과가 없습니다.</td>
            </tr>
            <tr th:each="r, stat : ${orderrows.content}">
              <td th:text="${r.date}">2025-01-01</td>
              <td th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}" th:text="${r.orderDate}">2025-01-01</td>
              <td th:text="${r.storeName}">Store A</td>
              <td th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}" th:text="${r.orderId}">123</td>
              <td th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}" th:text="${r.category}">Toast</td>
              <td th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}" th:text="${r.menu}">Bacon Egg</td>

              <td class="ta-r" th:text="${#numbers.formatDecimal(r.menuCount == null ? 0 : r.menuCount, 0, 'COMMA', 0, 'POINT')}">0</td>
              <td class="ta-r" th:text="${#numbers.formatDecimal(r.menuSales == null ? 0 : r.menuSales, 0, 'COMMA', 0, 'POINT')}">0</td>

              <td class="ta-r" th:text="${#numbers.formatDecimal(r.orderCount == null ? 0 : r.orderCount, 0, 'COMMA', 0, 'POINT')}">0</td>
              <td class="ta-r" th:text="${#numbers.formatDecimal(r.orderSales == null ? 0 : r.orderSales, 0, 'COMMA', 0, 'POINT')}"></td>

              <!-- ✅ OrderType은 일별만 -->
              <td th:if="${analyticsSearchDto.viewBy?.name() == 'DAY'}" th:text="${r.orderType}">VISIT</td>
            </tr>
            </tbody>
          </table>

          <div style="text-align:center;">
            <div th:replace="~{fragments/pagination :: pagination (${orderrows})}"></div>
          </div>
        </section>
      </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
  </div>
</div>
<script>
  // ✅ 모든 라디오 토글 그룹(active 스타일)을 동일하게 적용
  (function () {
	const groups = document.querySelectorAll('[data-bs-toggle="buttons"]');
	groups.forEach(group => {
	  const labels = group.querySelectorAll('label');
	  const inputs = group.querySelectorAll('input[type="radio"]');
	  inputs.forEach(input => {
		input.addEventListener('change', (e) => {
		  labels.forEach(lb => lb.classList.remove('active'));
		  e.target.closest('label').classList.add('active');
		});
	  });
	});
  })();
</script>
<script>
  function excelDownload() {
    const frm = document.getElementById('frm');
    const params = new URLSearchParams(new FormData(frm));
    const url = `/admin/API/analytics/orders/download?` + params.toString();
    window.location.href = url;
  }
  function pdfDownload() {
    const frm = document.getElementById('frm');
    const params = new URLSearchParams(new FormData(frm));
    const url = `/admin/API/analytics/orders/pdf/download?` + params.toString();
    window.location.href = url;
  }

  // 일별/월별 필터링 색상
  (function () {
    const group = document.querySelector('[data-bs-toggle="buttons"]');
    if (!group) return;
    const labels = group.querySelectorAll('label');
    const inputs = group.querySelectorAll('input[name="viewBy"]');
    inputs.forEach(input => {
      input.addEventListener('change', (e) => {
        labels.forEach(lb => lb.classList.remove('active'));
        e.target.closest('label').classList.add('active');
      });
    });
  })();

  // === 가맹점 필터 ===
  const sfRoot = document.getElementById('storeFilter');
  const sfBtn  = document.getElementById('storeFilterBtn');
  const sfMenu = document.getElementById('storeFilterMenu');
  const sfSearch = document.getElementById('storeSearch');
  const sfAll = document.getElementById('storeAll');
  const sfLabel = document.getElementById('storeFilterLabel');
  const sfList = sfMenu.querySelector('.filter-list');

  // 열기/닫기
  sfBtn.addEventListener('click', () => sfRoot.classList.toggle('open'));
  document.addEventListener('click', (e) => { if (!sfRoot.contains(e.target)) sfRoot.classList.remove('open'); });

  // '전체' 토글
  sfAll.addEventListener('change', () => {
    if (sfAll.checked) { sfList.querySelectorAll('input[name="storeIds"]').forEach(c => c.checked = false); }
    updateStoreLabel();
  });

  // 개별 체크 → 전체 해제 / 모두 해제 시 전체 자동선택
  sfList.addEventListener('change', (e) => {
    if (e.target.name !== 'storeIds') return;
    if (e.target.checked) sfAll.checked = false;
    const any = [...sfList.querySelectorAll('input[name="storeIds"]')].some(c => c.checked);
    if (!any) sfAll.checked = true;
    updateStoreLabel();
  });

  // 검색
  sfSearch.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    sfList.querySelectorAll('label').forEach(lb => {
      const txt = lb.querySelector('span').textContent.toLowerCase();
      lb.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  function updateStoreLabel() {
    if (sfAll.checked) { sfLabel.textContent = '전체'; return; }
    const selected = [...sfList.querySelectorAll('input[name="storeIds"]:checked')];
    if (selected.length === 1) {
      sfLabel.textContent = selected[0].closest('label').querySelector('span').textContent;
    } else {
      sfLabel.textContent = `선택 ${selected.length}개`;
    }
  }

  function applyStoreFilter(){ updateStoreLabel(); sfRoot.classList.remove('open'); }
  function resetStoreFilter(){
    sfAll.checked = true;
    sfList.querySelectorAll('input[name="storeIds"]').forEach(c => c.checked = false);
    sfSearch.value = '';
    sfList.querySelectorAll('label').forEach(lb => lb.style.display = '');
    updateStoreLabel();
  }

  document.getElementById('frm').addEventListener('submit', function () {
    const sfAll  = document.getElementById('storeAll');
    const sfList = document.querySelector('#storeFilter .filter-list');
    if (sfAll && sfAll.checked && sfList) {
      sfList.querySelectorAll('input[name="storeIds"]').forEach(c => c.disabled = true);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    const sfList = document.querySelector('#storeFilter .filter-list');
    const any = sfList && [...sfList.querySelectorAll('input[name="storeIds"]')].some(c => c.checked);
    document.getElementById('storeAll').checked = !any;
    updateStoreLabel();

    // ✅ 페이지 사이즈 변경 시 자동 조회 금지, page=1만 리셋
    const sizeSel = document.getElementById('pageSizeSelect');
    if (sizeSel) {
      sizeSel.addEventListener('change', () => {
        const pageHidden = document.querySelector('#frm input[name="page"]');
        if (pageHidden) pageHidden.value = 1;
      });
    }
  });
</script>

</body>
</html>