<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>FranFriend Admin — 회원가입</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root{
            --kpi-red:#ef4444; --kpi-green:#22c55e; --kpi-purple:#7c3aed;
            --light-gray:#f5f7fb; --dark-gray:#6b7280;
        }
        .bg-kpi-green{ background: var(--kpi-green); }
        .bg-kpi-purple{ background: var(--kpi-purple); }
        .bg-light-gray{ background: var(--light-gray); }
        .text-dark-gray{ color: var(--dark-gray); }

        /* 간단 입력/버튼 스타일 (Tailwind 유틸과 함께 사용) */
        .input{
            border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0 0.75rem; outline: none;
            width: 100%; height: 2.5rem;
        }
        .input:focus{ border-color:#6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
        .btn{
            border-radius: 0.5rem; color:#fff; font-weight:600;
            height: 2.75rem; line-height: 2.75rem;
        }
        .help{ min-height: 18px; } /* 도움말 영역 높이 확보해서 줄바꿈/겹침 방지 */
    </style>
</head>
<body class="min-h-screen bg-light-gray flex items-center justify-center">
<div class="w-full max-w-md px-6">
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <!-- 헤더 -->
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-kpi-purple rounded-2xl mx-auto mb-3 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12a5 5 0 100-10 5 5 0 000 10zM3 22a9 9 0 1118 0H3z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">관리자 회원가입</h1>
            <p class="text-sm text-dark-gray mt-1">FranFriend ERP 본사 콘솔</p>
        </div>

        <!-- 상단 메시지 -->
        <div id="msg" class="hidden mb-4 text-sm rounded-md px-3 py-2"></div>

        <!-- 폼 -->
        <form id="joinForm" class="space-y-4">
            <!-- 이메일 -->
            <label for="email" class="block text-sm font-medium text-gray-700">이메일</label>
            <input id="email" name="email" type="email" class="input" autocomplete="email" />
            <small id="emailHelp" class="help block mt-1 mb-3 text-xs text-gray-500"></small>

            <!-- 비밀번호 -->
            <label for="password" class="block text-sm font-medium text-gray-700">비밀번호</label>
            <input id="password" name="password" type="password" class="input" autocomplete="new-password" />
            <small id="passwordHelp" class="help block mt-1 mb-3 text-xs text-gray-500"></small>

            <!-- 비밀번호 확인 -->
            <label for="password2" class="block text-sm font-medium text-gray-700">비밀번호 확인</label>
            <input id="password2" name="password2" type="password" class="input" autocomplete="new-password" />
            <small id="password2Help" class="help block mt-1 mb-3 text-xs text-gray-500"></small>

            <!-- 이름 -->
            <label for="name" class="block text-sm font-medium text-gray-700">이름</label>
            <input id="name" name="name" type="text" class="input" autocomplete="name" />

            <!-- 연락처 -->
            <label for="phone" class="block text-sm font-medium text-gray-700">연락처</label>
            <input id="phone" name="phone" type="tel" class="input" autocomplete="tel" />

            <button id="btnSubmit" type="submit" class="btn w-full bg-gray-300 cursor-not-allowed" disabled>
                계정 생성
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 요소
        const $form = document.getElementById('joinForm');
        const $msg  = document.getElementById('msg');

        const $email = document.getElementById('email');
        const $emailHelp = document.getElementById('emailHelp');

        const $pw = document.getElementById('password');
        const $pwHelp = document.getElementById('passwordHelp');

        const $pw2 = document.getElementById('password2');
        const $pw2Help = document.getElementById('password2Help');

        const $name = document.getElementById('name');
        const $phone = document.getElementById('phone');
        const $btn = document.getElementById('btnSubmit');

        // 상태 플래그
        let emailOk = false, pwOk = false, pw2Ok = false;

        const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        function setMsg(text, ok){
            if (!text) { $msg.className = 'hidden'; $msg.textContent = ''; return; }
            $msg.textContent = text;
            $msg.className = ok
                ? 'mb-4 text-sm rounded-md px-3 py-2 bg-green-50 text-green-700 border border-green-200'
                : 'mb-4 text-sm rounded-md px-3 py-2 bg-red-50 text-red-700 border border-red-200';
        }

        function updateBtn() {
            const nameOk = !!$name.value.trim();
            const phoneOk = !!$phone.value.trim();
            const allOk = emailOk && pwOk && pw2Ok && nameOk && phoneOk;
            $btn.disabled = !allOk;
            if (allOk) {
                $btn.classList.remove('bg-gray-300','cursor-not-allowed');
                $btn.classList.add('bg-kpi-green');
            } else {
                $btn.classList.add('bg-gray-300','cursor-not-allowed');
                $btn.classList.remove('bg-kpi-green');
            }
        }

        // 이메일 중복 체크: blur 에서만 서버 호출
        async function checkEmailDup() {
            const v = $email.value.trim();

            if (!emailRe.test(v)) {
                $emailHelp.textContent = '이메일 형식을 확인하세요.';
                $emailHelp.className = 'help block mt-1 mb-3 text-xs text-red-600';
                emailOk = false; updateBtn(); return;
            }

            try {
                const res = await fetch(`/admin/api/auth/exist?email=${encodeURIComponent(v)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin'
                });
                if (!res.ok) throw new Error('exist http ' + res.status);
                const data = await res.json(); // {exists: boolean}
                if (data.exists) {
                    $emailHelp.textContent = '이미 사용 중인 이메일입니다.';
                    $emailHelp.className = 'help block mt-1 mb-3 text-xs text-red-600';
                    emailOk = false;
                } else {
                    $emailHelp.textContent = '사용 가능한 이메일입니다.';
                    $emailHelp.className = 'help block mt-1 mb-3 text-xs text-green-600';
                    emailOk = true;
                }
            } catch (e) {
                console.error(e);
                $emailHelp.textContent = '중복 확인 실패';
                $emailHelp.className = 'help block mt-1 mb-3 text-xs text-red-600';
                emailOk = false;
            } finally { updateBtn(); }
        }

        // 비밀번호 길이 체크
        function checkPw() {
            const v = $pw.value;
            if (v.length < 6) {
                $pwHelp.textContent = '비밀번호는 6자 이상이어야 합니다.';
                $pwHelp.className = 'help block mt-1 mb-3 text-xs text-red-600';
                pwOk = false;
            } else {
                $pwHelp.textContent = '';
                $pwHelp.className = 'help block mt-1 mb-3 text-xs text-gray-500';
                pwOk = true;
            }
            checkPw2(); // 확인값 동시 갱신
        }

        // 비밀번호 일치 체크
        function checkPw2() {
            if ($pw2.value && $pw.value !== $pw2.value) {
                $pw2Help.textContent = '비밀번호가 일치하지 않습니다.';
                $pw2Help.className = 'help block mt-1 mb-3 text-xs text-red-600';
                pw2Ok = false;
            } else if ($pw2.value) {
                $pw2Help.textContent = '일치합니다.';
                $pw2Help.className = 'help block mt-1 mb-3 text-xs text-green-600';
                pw2Ok = true;
            } else {
                $pw2Help.textContent = '';
                $pw2Help.className = 'help block mt-1 mb-3 text-xs text-gray-500';
                pw2Ok = false;
            }
            updateBtn();
        }

        // 이벤트 바인딩
        $email.addEventListener('input', () => { emailOk = false; $emailHelp.textContent = ''; updateBtn(); });
        $email.addEventListener('blur', checkEmailDup);

        $pw.addEventListener('input', checkPw);
        $pw2.addEventListener('input', checkPw2);

        $name.addEventListener('input', updateBtn);
        $phone.addEventListener('input', updateBtn);

        // 제출
        $form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setMsg('', true);

            // 최종 가드
            if ($btn.disabled) { setMsg('입력 값을 확인해주세요.', false); return; }

            const payload = {
                email: $email.value.trim(),
                password: $pw.value,
                name: $name.value.trim(),
                phone: $phone.value.trim()
            };

            try {
                const res = await fetch('/admin/API/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });

                if (res.status === 201) {
                    setMsg('회원가입이 완료되었습니다. 로그인 화면으로 이동합니다.', true);
                    setTimeout(() => { window.location.href = '/admin/login'; }, 600);
                    return;
                }

                // 에러 처리
                const text = await res.text();
                if (res.status === 409 || text.includes('EMAIL_IN_USE')) {
                    setMsg('이미 사용 중인 이메일입니다.', false);
                } else {
                    setMsg('회원가입 중 오류가 발생했습니다.', false);
                }
            } catch (err) {
                console.error(err);
                setMsg('네트워크 오류가 발생했습니다.', false);
            }
        });

        // 초기 버튼 상태
        updateBtn();
    });
</script>
</body>
</html>
