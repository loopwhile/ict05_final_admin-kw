<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
    <!-- Bootstrap CSS CDN -->
    <th:block th:replace="~{fragments/head :: commonHead}"></th:block>

    <link href="/admin/css/toast.css" rel="stylesheet"/>
    <script src="/admin/js/lib/jquery-3.2.1.min.js"></script>
    <script src="/admin/js/toast.js"></script>

    <title>토스트랩 관리자</title>

    <style>
         .row-4 .col.box-wrap {
            background: #fff;
            border-radius: 14px;       /* 모서리 둥글게 */
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            padding: 20px;
            text-align: center;
        }

         .row-4 .col.box-wrap div:first-child {
            color: #666;
            font-size: 15px;
            margin-bottom: 6px;
        }

         .row-4 .col.box-wrap div:last-child {
            font-weight: 700;          /* 굵게 */
            color: #000;               /* 검정색 */
            font-size: 20px;
        }

        .overlay {
          display: none;
          position: fixed;
          top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 9999;

          /* 중앙 정렬을 위한 Flexbox 설정 */
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .overlay.active {
          display: flex; /* active 상태일 때 flex 정렬 유지 */
        }

        .pop-close {
          width: 48px;   /* 버튼 크기 증가 */
          height: 48px;
          padding: 8px;
          border: none;
          background: transparent;
          cursor: pointer;
        }

        /* 팝업 박스 자체 크기 고정 */
        .popup {
          background: white;
          width: 630px;            /* 보기 좋은 중간 크기 */
          max-width: 92vw;         /* 작은 화면 대응 */
          height: 750px;
          border-radius: 8px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }

        /* 팝업 body 부분만 스크롤되도록 */
        .popup-body {
          flex: 3;                       /* 남은 공간 모두 차지 */
          overflow-y: auto;             /* 내용이 넘칠 때만 스크롤 */
          padding: 25px;
        }

        .popup-body .box-wrap {
          margin: 16px auto;         /* 가운데 정렬 */
          padding: 25px;             /* 여백 확대 */
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.15);
          width: 95%;                /* 카드 폭 확대 */
          max-width: 100%;           /* 팝업 내부 꽉 차게 */
          box-sizing: border-box;
        }

        /* 주문정보, 가맹점정보 나란히 */
        .info-row {
          display: flex;
          gap: 15px;
          margin-bottom: 20px;
        }

        .info-card {
          flex: 1;
          display: flex;
          flex-direction: column;
          background: #f9f9f9;
          border-radius: 8px;
          padding: 15px 20px;
          box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
          box-sizing: border-box;
          min-height: 100%; /* 높이 균형 유지 */
        }

        .info-card h4 {
          margin-bottom: 12px;
          font-size: 14px;
          font-weight: 600;
          color: #222;
        }

        .info-line {
          display: flex;
          align-items: center;     /* 세로 가운데 정렬 */
          justify-content: space-between;
          gap: 8px;                /* 라벨-값 간 간격 */
          margin-bottom: 6px;
          white-space: nowrap;     /* 한 줄 유지 */
        }

        .info-line .label {
          font-weight: 500;
        }

        .info-line .value {
          font-weight: 400;
          color: #222;
          text-align: right;
          flex: 1;                /* 라벨 오른쪽 정렬 여유 확보 */
        }

        .overlay {
          display: none;
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0,0,0,0.5);
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }
        .overlay.active {
          display: flex;
        }


        /* 주문 상품 테이블 */
        #itemTable {
          width: 100%;
          border-collapse: collapse;
          margin-top: 12px;
          table-layout: fixed;     /* 칸 너비 균등 분배 */
          background: #fafafa;
          box-shadow: 0 0 0 1px #e0e0e0 inset;
        }

        #itemTable thead {
          background: #f3f3f3;
        }

        /* 제목은 한 줄 유지 */
        #itemTable th {
          font-size: 14px;
          font-weight: 600;
          color: #555;
          padding: 10px 12px;
          text-align: center;
          border-bottom: 1px solid #e0e0e0;
          white-space: nowrap; /* 줄바꿈 방지 */
          table-layout: fixed;     /* 균등 분배 유지 */
        }

        /* 내용은 줄바꿈 허용 */
        #itemTable td {
          padding: 10px 12px;
          text-align: center;
          font-size: 14px;
          color: #222;
          border-bottom: 1px solid #eaeaea;
          word-break: keep-all;
          white-space: normal; /* 자동 줄바꿈 허용 */
        }

        /* 마지막 행 밑줄 제거 */
        #itemTable tr:last-child td {
          border-bottom: none;
        }

        #itemTable tbody tr:hover {
          background-color: #f9f9f9;
          transition: background-color 0.2s ease;
        }

    </style>
</head>
<body>
<div id="wrap" class="frame">
    <div th:replace="~{fragments/header :: header}"></div>

    <div id="container" class="container">
        <div class="title-bar">
            <h2 class="page-title ellipsis">수주 현황</h2>
        </div>

        <main id="content" class="pack-down gap-20">
            <div class="row-4">
                <div class="col box-wrap">
                    <div>전체 주문</div>
                    <div th:text="${summary.totalCount}">0</div>
                </div>
                <div class="col box-wrap">
                    <div>총 주문액</div>
                    <div th:text="${#numbers.formatInteger(summary.totalAmount, 0, 'COMMA')} + '원'">0원</div>
                </div>
                <div class="col box-wrap">
                    <div>배송중</div>
                    <div th:text="${summary.shippingCount}">0</div>
                </div>
                <div class="col box-wrap">
                    <div>우선 주문</div>
                    <div th:text="${summary.urgentCount}">0</div>
                </div>
            </div>


            <div class="box-wrap">
                <div id="search" class="search">
                    <form name="frm" id="frm" method="get">
                        <fieldset>
                            <legend class="blind">검색</legend>
                            <div class="pack-both">
                                <div class="pack-left" style="width:30%" >
                                    <input title="검색어" type="search" name="s" th:value="${receiveOrderSearchDTO.s}" class="input-text medium form-control" placeholder="가맹점명, 주문번호, 지역 검색" />
                                    <input type="submit" value="검색" class="btn medium color1"/>
                                </div>

                                <div class="pack-left">
                                    <!--상태 필터-->
                                    <div class="btn medium bdr-color1 btn-group btn-group-toggle" data-bs-toggle="buttons">
                                        <label class="btn medium"
                                               th:classappend="${receiveOrderSearchDTO.receiveOrderStatus == null or #strings.isEmpty(receiveOrderSearchDTO.receiveOrderStatus)} ? ' active' : ''">
                                            <input type="radio" name="receiveOrderStatus" value=""
                                                   th:checked="${receiveOrderSearchDTO.receiveOrderStatus == null or #strings.isEmpty(receiveOrderSearchDTO.receiveOrderStatus)}"
                                                   onclick="setFilter('')">전체
                                        </label>

                                        <label class="btn medium"
                                               th:classappend="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'RECEIVED'} ? ' active' : ''">
                                            <input type="radio" name="receiveOrderStatus" value="RECEIVED"
                                                   th:checked="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'RECEIVED'}"
                                                   onclick="setFilter('RECEIVED')">접수
                                        </label>

                                        <label class="btn medium"
                                               th:classappend="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'SHIPPING'} ? ' active' : ''">
                                            <input type="radio" name="receiveOrderStatus" value="SHIPPING"
                                                   th:checked="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'SHIPPING'}"
                                                   onclick="setFilter('SHIPPING')">배송
                                        </label>

                                        <label class="btn medium"
                                               th:classappend="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'DELIVERED'} ? ' active' : ''">
                                            <input type="radio" name="receiveOrderStatus" value="DELIVERED"
                                                   th:checked="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'DELIVERED'}"
                                                   onclick="setFilter('DELIVERED')">완료
                                        </label>

                                        <label class="btn medium"
                                               th:classappend="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'CANCELED'} ? ' active' : ''">
                                            <input type="radio" name="receiveOrderStatus" value="CANCELED"
                                                   th:checked="${receiveOrderSearchDTO.receiveOrderStatus?.name() == 'CANCELED'}"
                                                   onclick="setFilter('CANCELED')">취소
                                        </label>
                                    </div>

                                    <!--페이지 사이즈-->
                                    <div class="pack-left page-size">
                                        <select title="뷰사이즈" th:field="${receiveOrderSearchDTO.size}" class="select medium"
                                                onchange="setPageSize(this.value)">
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="30">30</option>
                                            <option value="50">50</option>
                                        </select>
                                        <span class="fs-ss">개씩 보기</span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>

                <section class="pack-down">
                    <div class="list-header pack-both">
                        <div></div>
                        <div class="pack-left">
                            <button type="button" class="btn medium bdr-color1" onclick="excelDownload()">엑셀다운로드</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                        <tr>
                            <!--<th scope="col"><input type="checkbox" name="" id="selectAll"/></th>-->
                            <th scope="col">가맹점명</th>
                            <th scope="col">주문번호</th>
                            <th scope="col">지역</th>
                            <th scope="col">상태</th>
                            <th scope="col">우선순위</th>
                            <th scope="col">주문액</th>
                            <th scope="col">품목수</th>
                            <th scope="col">배송완료일</th>
                            <th scope="col">관리</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order, stat : ${receiveOrder.content}">
                            <td th:text="${order.storeName}">가맹점명</td>
                            <td th:text="${order.orderCode}">주문번호</td>
                            <td th:text="${order.storeLocation}">지역</td>
                            <td>
                                <span th:class="|badge rounded-pill ${
                                    order.status.name() == 'RECEIVED' ? 'bg-warning' :
                                    (order.status.name() == 'SHIPPING' ? 'bg-primary' :
                                    (order.status.name() == 'DELIVERED' ? 'bg-success' :
                                    (order.status.name() == 'CANCELED' ? 'bg-secondary' : 'bg-light')))}|"
                                      th:text="${order.status.description}">
                                </span>

                            </td>
                            <td th:text="${order.priority.description}"
                                th:style="${order.priority.name() == 'URGENT'} ? 'color:red;' : ''">
                                우선순위
                            </td>
                            <td th:text="${#numbers.formatInteger(order.totalPrice, 0, 'COMMA')} + '원'">주문액</td>
                            <td th:text="${order.totalCount}">품목수</td>
                            <td th:text="${order.actualDeliveryDate != null ? #temporals.format(order.actualDeliveryDate, 'yyyy-MM-dd') : '-'}">
                                배송완료일
                            </td>
                            <td>
                                <button type="button"
                                        class="btn small normal"
                                        th:onclick="|openPopup(${order.id})|">
                                    <span class="material-symbols-outlined">visibility</span>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div style="text-align: center;">
                        <div th:replace="~{fragments/pagination :: pagination (${receiveOrder})}"></div>
                    </div>
                </section>
            </div>
        </main>
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div><!-- // #container  -->
</div><!--#wrap.frame-->

<!-- popup 시작 -->
<!-- 각 주문마다 하나의 팝업 생성 -->
<div th:each="order : ${receiveOrder.content}"
     th:with="detail=${orderDetails[order.id]}"
     th:id="'popup-' + ${order.id}"
     class="overlay">

    <div class="popup">
        <!-- Header -->
        <div class="popup-header">
            <h2 class="popup-title">주문 상세 정보</h2>
            <button type="button" class="btn transparent pop-close"
                    th:onclick="'modalClose(' + '\'' + '#popup-' + ${order.id} + '\'' + ')'"
                    title="팝업 닫기">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="fs-14">
                <p>주문번호 :
                    <span th:text="${detail.orderCode}">주문번호</span>
                </p>
            </div>
        </div>

        <hr class="line">

        <!-- Body -->
        <div class="popup-body">
            <div class="info-row">
                <!-- 주문 정보 -->
                <section class="col box-wrap">
                    <h3 style="color:black; font-weight:600;">주문 정보</h3>
                    <hr>
                    <div class="info-line"><div class="label">주문번호:</div><div class="value" th:text="${detail.orderCode}"></div></div>
                    <div class="info-line"><div class="label">주문일:</div><div class="value" th:text="${#temporals.format(detail.orderDate, 'yyyy-MM-dd')}"></div></div>
                    <div class="info-line"><div class="label">배송완료일:</div><div class="value" th:text="${detail.actualDeliveryDate != null ? #temporals.format(detail.actualDeliveryDate, 'yyyy-MM-dd') : '-'}"></div></div>
                    <div class="info-line"><div class="label">상태:</div><div class="value" th:text="${detail.statusDescription}"></div></div>
                    <div class="info-line"><div class="label">우선순위:</div><div class="value" th:text="${detail.priorityDescription}"></div></div>
                </section>

                <!-- 가맹점 정보 -->
                <section class="col box-wrap">
                    <h3 style="color:black; font-weight:600;">가맹점 정보</h3>
                    <hr>
                    <div class="info-line"><div class="label">가맹점명:</div><div class="value" th:text="${detail.storeName}"></div></div>
                    <div class="info-line"><div class="label">매장코드:</div><div class="value" th:text="${detail.storeId}"></div></div>
                    <div class="info-line"><div class="label">지역:</div><div class="value" th:text="${detail.storeLocation}"></div></div>
                    <div class="info-line"><div class="label">총 주문액:</div><div class="value" th:text="${#numbers.formatInteger(detail.totalPrice, 0, 'COMMA')} + '원'"></div></div>
                    <div class="info-line"><div class="label">주문 품목:</div><div class="value" th:text="${detail.totalCount}"></div></div>
                </section>
            </div>

            <hr class="line">

            <!-- 주문 상품 -->
            <section class="box-wrap">
                <h3 style="color:black; font-weight:600;">주문 상품</h3>
                <hr class="line">

                <table id="itemTable">
                    <thead>
                    <tr>
                        <th>상품명</th>
                        <th>카테고리</th>
                        <th>수량</th>
                        <th>단가</th>
                        <th>총액</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item, iterStat : ${detail.items}">
                        <td th:text="${item.name}"></td>
                        <td th:text="${item.materialCategory}"></td>
                        <td th:text="${item.detailCount}"></td>
                        <td th:text="${#numbers.formatInteger(item.detailUnitPrice,0,'COMMA')} + '원'"></td>
                        <td th:text="${#numbers.formatInteger(item.detailTotalPrice,0,'COMMA')} + '원'"></td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <hr class="line">

            <!-- 특이사항 -->
            <section class="col box-wrap">
                <h3 style="color:black; font-weight:600;">특이 사항</h3>
                <hr class="line">
                <textarea class="textarea medium" rows="4" cols="50"
                          th:text="${detail.remark}" readonly
                          style="color: black;"></textarea>
            </section>

            <hr class="line">

            <!-- 버튼 영역 -->
            <div class="button-area pack-center" style="float: right;">
                <button type="button"
                        class="btn medium bdr-color1"
                        th:onclick="|window.location.href='/admin/API/receive/download/' + ${order.id}|">
                    <span class="material-symbols-outlined">download</span>
                    주문서 다운로드
                </button>

                <button type="button"
                        class="btn medium color1"
                        th:attr="id='updateStatusBtn-' + ${order.id}, data-status=${order.status.name()}"
                        th:onclick="|event.preventDefault(); updateStatus(${order.id})|"
                        th:disabled="${order.status.name() == 'DELIVERED' or order.status.name() == 'CANCELED'}">
                    <span class="material-symbols-outlined"
                          th:attr="id='statusIcon-' + ${order.id}"
                          th:text="${order.status.name() == 'RECEIVED' ? 'local_shipping'
                                   : order.status.name() == 'SHIPPING' ? 'check_circle'
                                   : order.status.name() == 'DELIVERED' ? 'done_all'
                                   : order.status.name() == 'CANCELED' ? 'cancel'
                                   : 'help'}">
                    </span>
                    <span th:attr="id='statusLabel-' + ${order.id}"
                          th:text="${order.status.name() == 'RECEIVED' ? '배송 시작'
                       : order.status.name() == 'SHIPPING' ? '배송 완료 대기'
                       : order.status.name() == 'DELIVERED' ? '완료됨'
                       : order.status.name() == 'CANCELED' ? '취소됨'
                       : '알 수 없음'}">
                    </span>
                </button>

                <button type="button"
                        class="btn medium color2"
                        th:if="${order.status.name() == 'RECEIVED'}"
                        th:onclick="|cancelOrder(${order.id})|">
                    <span class="material-symbols-outlined">cancel</span>
                    <span>접수 취소</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- popup 끝 -->

<script>
    /** 상태 필터 변경 */
    function setFilter(status) {
        const params = new URLSearchParams(window.location.search);
        if (status) {
            params.set("receiveOrderStatus", status);
        } else {
            params.delete("receiveOrderStatus");
        }
        params.set("page", 1);
        window.location.href = `/admin/receive/list?${params.toString()}`;
    }

    /** 페이지 사이즈 변경 */
    function setPageSize(size) {
        const params = new URLSearchParams(window.location.search);
        params.set("size", size);
        params.set("page", 1);
        window.location.href = `/admin/receive/list?${params.toString()}`;
    }

    /** 엑셀 다운로드 */
    function excelDownload() {
        const params = new URLSearchParams(window.location.search);
        window.location.href = `/admin/API/receive/download?${params.toString()}`;
    }

    /** 팝업 열기 */
    function openPopup(id) {
        const popup = document.getElementById('popup-' + id);
        if (!popup) {
            console.warn('팝업을 찾을 수 없음: popup-' + id);
            return;
        }
        popup.classList.add('active');

        // 스크롤 초기화
        const body = popup.querySelector('.popup-body');
        if (body) {
            body.scrollTop = 0;
        }
    }

    /** 팝업 닫기 */
    function modalClose(selector) {
        const popup = document.querySelector(selector);
        if (popup) {
            popup.classList.remove('active');
        }
    }

    /**
     * 배송 상태 업데이트
     * 서버에서 내려준 에러 메시지(예: 본사 재고 부족)를 그대로 alert로 보여준다.
     */
    function updateStatus(id) {
        const btn   = document.getElementById('updateStatusBtn-' + id);
        const icon  = document.getElementById('statusIcon-' + id);
        const label = document.getElementById('statusLabel-' + id);

        if (!btn || !icon || !label) {
            console.warn('요소를 찾을 수 없음:', id);
            return;
        }

        const currentText = label.textContent.trim();
        console.log('현재 상태 라벨:', currentText);

        // 1) 접수 상태에서 배송 시작
        if (currentText === '배송 시작' || currentText === '접수됨') {
        fetch(`/admin/API/receive/status/${id}?action=SHIP`, { method: 'PUT' })
            .then(res =>
                res.text().then(text => ({
                    ok: res.ok,
                    status: res.status,
                    text: text
                }))
            )
            .then(result => {
                if (!result.ok) {
                    let msg;

                    if (result.status === 409) {
                        // 409 인 경우에는 항상 사용자용 문구만 노출
                        msg = '본사 재고가 부족하여 출고를 생성할 수 없습니다.';
                        console.error('출고 생성 실패(409):', result.text);
                    } else if (result.text && result.text.trim().length > 0) {
                        msg = result.text.trim();
                    } else {
                        msg = '상태 업데이트 실패';
                    }

                    alert(msg);
                    throw new Error(msg);
                }

                icon.textContent = 'local_shipping';
                label.textContent = '배송 중';
                toastMessage('배송 상태가 "배송 중"으로 변경되었습니다.');
                modalClose('#popup-' + id);
                location.reload();
            })
            .catch(err => {
                console.error('배송 시작 실패:', err);
            });
        return;
        }

        // 2) 배송 중에서 완료 처리
        if (currentText === '배송 중' || currentText === '배송 완료 대기') {
            if (!confirm('해당 주문을 완료 상태로 변경하시겠습니까?')) {
                return;
            }

            fetch(`/admin/API/receive/status/${id}?action=SHIP`, { method: 'PUT' })
                .then(res =>
                    res.text().then(text => ({
                        ok: res.ok,
                        status: res.status,
                        text: text
                    }))
                )
                .then(result => {
                    if (!result.ok) {
                        const msg = result.text && result.text.trim().length > 0
                            ? result.text.trim()
                            : '상태 업데이트 실패';
                        alert(msg);
                        throw new Error(msg);
                    }

                    icon.textContent = 'done_all';
                    label.textContent = '완료됨';
                    btn.disabled = true;
                    toastMessage('배송 상태가 "완료됨"으로 변경되었습니다.');
                    modalClose('#popup-' + id);
                    location.reload();
                })
                .catch(err => {
                    console.error('배송 완료 처리 실패:', err);
                });
            return;
        }

        // 3) 이미 완료 상태
        if (currentText === '완료됨') {
            btn.disabled = true;
            toastMessage('이미 완료된 주문입니다.');
            modalClose('#popup-' + id);
        }
    }

    /** 접수 취소 */
    function cancelOrder(id) {
        if (!confirm('정말 이 주문을 취소하시겠습니까?')) {
            return;
        }

        fetch(`/admin/API/receive/status/${id}?action=CANCEL`, { method: 'PUT' })
            .then(res =>
                res.text().then(text => ({
                    ok: res.ok,
                    status: res.status,
                    text: text
                }))
            )
            .then(result => {
                if (!result.ok) {
                    const msg = result.text && result.text.trim().length > 0
                        ? result.text.trim()
                        : '취소 실패';
                    alert(msg);
                    throw new Error(msg);
                }

                toastMessage('주문이 취소되었습니다.');
                modalClose('#popup-' + id);
                location.reload();
            })
            .catch(err => {
                console.error('주문 취소 실패:', err);
            });
    }

    /** 간단한 알림 표시 */
    function toastMessage(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        Object.assign(toast.style, {
            position: 'fixed',
            bottom: '30px',
            left: '50%',
            transform: 'translateX(-50%)',
            background: '#333',
            color: '#fff',
            padding: '10px 16px',
            borderRadius: '6px',
            zIndex: '99999',
        });
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }
</script>
</body>
</html>
